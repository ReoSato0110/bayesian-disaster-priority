# 技術的説明書

## アプリケーション概要

本アプリケーションは、ベイズ統計学の手法を用いて、災害支援要請の優先度を数値化するデモンストレーションアプリケーションである。意思決定を自動化するものではなく、判断の補助情報として統計的な指標を提供することを目的とする。

## 実装されている技術的機能

### 1. ベイズ統計計算（bayes.py）

#### 1.1 共役事前分布の利用
- **事前分布**: ベータ分布 Beta(α, β)
- **尤度関数**: 二項分布（成功回数 s、試行回数 n）
- **事後分布**: ベータ分布 Beta(α + s, β + n - s)

ベータ分布は二項分布の共役事前分布であるため、事後分布のパラメータは解析的に計算可能である。この性質により、数値積分を必要とせずに事後分布を求めることができる。

#### 1.2 事後平均の計算
事後平均は以下の式で計算される：

```
E[θ|data] = (α + s) / (α + β + n)
```

ここで、θは支援が必要な確率、sは成功回数（支援が必要だった回数）、nは総試行回数である。

#### 1.3 最高密度区間（HDI）の計算
94%HDI（Highest Density Interval）は、事後分布の確率密度が最も高い区間で、指定された確率質量（94%）を含む区間として定義される。

実装では、scipy.optimize.minimize_scalar を用いた数値最適化により、区間の幅を最小化する下端点を探索している。上端点は累積分布関数（CDF）の逆関数（PPF）を用いて計算される。

HDIは等尾区間（equal-tailed interval）とは異なり、非対称な分布においてより適切な区間推定を提供する。

### 2. 優先度スコア計算（logic.py）

#### 2.1 スコア計算式
優先度スコアは、事後平均と緊急度の線形結合として計算される：

```
priority_score = (posterior_mean × 0.6 + urgency_weight × 0.4) × 100
```

- **事後平均の重み**: 0.6（過去データを重視）
- **緊急度の重み**: 0.4（主観的判断を反映）
- **出力範囲**: 0.0 〜 100.0

この重み付けは、データドリブンな判断を重視しつつ、主観的な緊急度も反映する設計である。

#### 2.2 入力パラメータ
- `successes`: 過去に支援が必要だった回数（非負整数）
- `total_trials`: 報告・観測回数（正の整数）
- `urgency_weight`: 主観的な緊急度（0.0 〜 1.0 の実数）
- `alpha`, `beta`: ベータ分布の事前分布パラメータ（デフォルト値: 1.0, 1.0）

デフォルトの事前分布パラメータ（α=1, β=1）は一様分布（Uniform(0,1)）に相当し、事前情報がない場合の無情報事前分布として機能する。

### 3. データ管理（data.py）

#### 3.1 データ構造
各支援要請は以下のキーを持つ辞書型データ構造として表現される：

- `id`: 要請の一意識別子（整数）
- `title`: 要請のタイトル（文字列）
- `description`: 状況説明（文字列）
- `successes`: 過去に支援が必要だった回数（整数）
- `total_trials`: 報告・観測回数（整数）
- `urgency_weight`: 緊急度（0.0 〜 1.0 の浮動小数点数）

#### 3.2 データアクセス関数
- `get_all_requests()`: 全支援要請データのリストを返す。データの不変性を保つため、リストの各要素は浅いコピー（shallow copy）として返される。
- `get_request_by_id(request_id)`: IDに対応する支援要請を返す。該当するIDが存在しない場合は None を返す。

現在の実装では、データはメモリ内の定数リストとして保持されており、永続化や外部データソースへの接続は実装されていない。

### 4. ユーザーインターフェース（app.py）

#### 4.1 フレームワーク
Streamlitフレームワークを使用して、Pythonコードから直接Webアプリケーションを構築している。

#### 4.2 UIコンポーネント
- **st.selectbox**: 支援要請の選択UI。選択肢は「ID: タイトル」形式で表示される。
- **st.metric**: 数値データの表示（過去データ、緊急度、優先度スコア、事後平均、HDI）
- **st.progress**: 0.0 〜 1.0 の値を視覚的に表示（緊急度、優先度スコア）
- **st.expander**: 詳細統計情報を展開可能なセクションとして表示

#### 4.3 インタラクション設計
- ユーザー入力は支援要請の選択のみ
- 選択変更時に自動的にスコアが再計算される（明示的なボタン操作は不要）
- エラーハンドリングは try-except ブロックで実装され、エラー発生時は st.error と st.exception で表示される

## 統計学的な前提と制約

### 前提条件
1. **二項データの独立性**: 各試行は独立であると仮定
2. **事前分布の選択**: ベータ分布を事前分布として使用（共役性を利用）
3. **一様事前分布**: デフォルトでは無情報事前分布（α=1, β=1）を使用

### 制約事項
1. **データの仮定**: 過去のデータが将来の確率を予測するための十分な情報を含むと仮定
2. **緊急度の主観性**: `urgency_weight` は主観的な評価であり、客観的な測定値ではない
3. **線形結合の単純化**: 優先度スコアは事後平均と緊急度の線形結合であり、非線形な相互作用は考慮されていない
4. **重みパラメータの固定**: 事後平均と緊急度の重み（0.6, 0.4）は固定値であり、データに応じた動的調整は行われない

## 計算の複雑度

- **事後分布の計算**: O(1) - 共役性により解析的に計算可能
- **HDIの計算**: O(k) - kは最適化の反復回数（通常は数十回程度）
- **優先度スコアの計算**: O(1) - 線形結合のため定数時間
- **全体の計算時間**: 実用的にはミリ秒単位で完了

## 使用しているライブラリ

- **scipy.stats**: 確率分布の計算（ベータ分布のCDF、PPF）
- **scipy.optimize**: HDI計算のための数値最適化
- **numpy**: 数値計算の基盤
- **streamlit**: Webアプリケーションフレームワーク
- **typing**: 型ヒントによる型安全性の向上

## 実装上の注意点

1. **データの不変性**: `data.py` の関数はデータのコピーを返すため、返されたデータの変更が元データに影響しない
2. **入力値の検証**: 各関数は入力パラメータの範囲チェックを実装している
3. **浮動小数点誤差**: 優先度スコアの計算結果は 0.0 〜 100.0 の範囲にクリッピングされる
4. **エラーハンドリング**: UI層では例外を捕捉し、ユーザーに分かりやすい形式で表示する

## デモ・学習目的の制約

- 実装されているデータは架空のサンプルデータである
- データベースやAPIとの連携は実装されていない
- 認証・認可機能は実装されていない
- データの永続化機能は実装されていない
- 複数ユーザー間でのデータ共有機能は実装されていない
